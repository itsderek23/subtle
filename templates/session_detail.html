{% extends "base.html" %}

{% block title %}Session {{ session_id[:8] }}... - Subtle{% endblock %}

{% block content %}
<div x-data="sessionDetailApp('{{ session_id }}')">
    <div class="mb-6">
        <a href="/" class="text-white/40 hover:text-white/70 text-sm">&larr; Back to sessions</a>
        <h2 class="text-lg text-white/70 mt-2">
            Session <span class="text-white/50">{{ session_id[:8] }}...</span>
        </h2>
    </div>

    <div class="bg-white/[0.02] rounded-lg border border-white/10 overflow-hidden">
        <table class="w-full text-sm">
            <thead>
                <tr class="border-b border-white/10 text-white/50 text-left">
                    <th class="px-4 py-3 font-medium w-28">Type</th>
                    <th class="px-4 py-3 font-medium">Message</th>
                    <th class="px-4 py-3 font-medium w-24">Time</th>
                    <th class="px-4 py-3 font-medium w-20">Model</th>
                    <th class="px-4 py-3 font-medium w-20 text-right">Tokens</th>
                    <th class="px-4 py-3 font-medium w-32">Tools</th>
                </tr>
            </thead>
            <tbody>
                <template x-if="loading">
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-white/40">
                            Loading messages...
                        </td>
                    </tr>
                </template>
                <template x-if="!loading && messages.length === 0">
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-white/40">
                            No messages found
                        </td>
                    </tr>
                </template>
                <template x-for="message in messages" :key="message.index">
                    <tr class="border-b border-white/5 hover:bg-white/[0.02] cursor-pointer transition-colors"
                        :class="{'bg-white/[0.04]': selectedIndex === message.index}"
                        @click="selectMessage(message.index)">
                        <td class="px-4 py-3">
                            <span :class="typeClass(message.type)" x-text="message.type"></span>
                        </td>
                        <td class="px-4 py-3 text-white/60 truncate max-w-md" x-text="message.preview || '–'"></td>
                        <td class="px-4 py-3 text-white/40" x-text="formatTime(message.timestamp)"></td>
                        <td class="px-4 py-3 text-white/40" x-text="formatModel(message.model)"></td>
                        <td class="px-4 py-3 text-right text-white/40">
                            <template x-if="message.input_tokens || message.output_tokens">
                                <span>
                                    <span x-text="message.input_tokens || 0"></span>
                                    <span class="text-white/20">/</span>
                                    <span x-text="message.output_tokens || 0"></span>
                                </span>
                            </template>
                            <template x-if="!message.input_tokens && !message.output_tokens">
                                <span>–</span>
                            </template>
                        </td>
                        <td class="px-4 py-3 text-white/40 truncate max-w-[8rem]" x-text="message.tools.join(', ') || '–'"></td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <!-- Side Panel -->
    <div x-show="panelOpen"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/50 z-40"
         @click="closePanel()">
    </div>

    <div x-show="panelOpen"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="translate-x-full"
         x-transition:enter-end="translate-x-0"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="translate-x-0"
         x-transition:leave-end="translate-x-full"
         class="fixed top-0 right-0 h-full w-1/2 max-w-2xl bg-[#0a0a0c] border-l border-white/10 z-50 flex flex-col"
         @click.stop>
        <div class="flex items-center justify-between px-4 py-3 border-b border-white/10">
            <h3 class="text-white/70 text-sm">
                Message <span class="text-white/40" x-text="selectedIndex"></span>
            </h3>
            <button @click="closePanel()" class="text-white/40 hover:text-white/70 text-xl">&times;</button>
        </div>
        <div class="flex-1 overflow-auto p-4">
            <template x-if="panelLoading">
                <div class="text-white/40 text-sm">Loading...</div>
            </template>
            <template x-if="!panelLoading && rawMessage">
                <pre class="text-xs text-white/70 whitespace-pre-wrap break-words" x-text="JSON.stringify(rawMessage, null, 2)"></pre>
            </template>
        </div>
    </div>
</div>
{% endblock %}
