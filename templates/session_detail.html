{% extends "base.html" %}

{% block title %}Session {{ session_id[:8] }}... - Subtle{% endblock %}

{% block content %}
<div x-data="sessionDetailApp('{{ session_id }}')">
    <div class="mb-6">
        <a href="/" class="text-white/40 hover:text-white/70 text-sm">&larr; Back to sessions</a>
        <h2 class="text-lg text-white/70 mt-2">
            Session <span class="text-white/50">{{ session_id[:8] }}...</span>
        </h2>
    </div>

    <div class="mb-6 grid grid-cols-4 gap-4" x-show="!loading">
        <div class="bg-white/[0.02] rounded-lg border border-white/10 p-4">
            <div class="text-white/40 text-xs uppercase mb-1">Commits</div>
            <div class="text-2xl text-purple-400" x-text="summary.commits"></div>
        </div>
        <div class="bg-white/[0.02] rounded-lg border border-white/10 p-4">
            <div class="text-white/40 text-xs uppercase mb-1">Tool LOC</div>
            <div class="text-lg">
                <span class="text-green-400" x-text="'+' + summary.toolLoc.added"></span>
                <span class="text-white/30">/</span>
                <span class="text-red-400" x-text="'-' + summary.toolLoc.removed"></span>
            </div>
        </div>
        <div class="bg-white/[0.02] rounded-lg border border-white/10 p-4">
            <div class="text-white/40 text-xs uppercase mb-1">Git LOC</div>
            <div class="text-lg" x-show="summary.gitLoc.found">
                <span class="text-green-400" x-text="'+' + summary.gitLoc.added"></span>
                <span class="text-white/30">/</span>
                <span class="text-red-400" x-text="'-' + summary.gitLoc.removed"></span>
            </div>
            <div class="text-lg text-white/30" x-show="!summary.gitLoc.found">–</div>
        </div>
        <div class="bg-white/[0.02] rounded-lg border border-white/10 p-4">
            <div class="text-white/40 text-xs uppercase mb-1">Messages</div>
            <div class="text-2xl text-white/70" x-text="messages.length"></div>
        </div>
    </div>

    <!-- Message Breakdown -->
    <div x-data="messageBreakdownApp('{{ session_id }}')" class="mb-6">
        <div class="bg-white/[0.02] rounded-lg border border-white/10 p-4" x-show="!loading && breakdown.length > 0">
            <div class="text-white/40 text-xs uppercase mb-3">Message Breakdown</div>
            <div class="space-y-2">
                <template x-for="item in breakdown" :key="item.category">
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <span class="font-mono text-xs text-white/70" x-text="item.category"></span>
                            <span class="font-mono text-[10px] text-white/40" x-text="item.count"></span>
                        </div>
                        <div class="h-2 w-full overflow-hidden rounded-full bg-white/5">
                            <div class="h-full rounded-full transition-all duration-500"
                                 :style="`width: ${getPercentage(item.count)}%; background-color: ${getColor(item.type)}`">
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <div class="bg-white/[0.02] rounded-lg border border-white/10 overflow-hidden">
        <table class="w-full text-sm">
            <thead>
                <tr class="border-b border-white/10 text-white/50 text-left">
                    <th class="px-4 py-3 font-medium w-28">Type</th>
                    <th class="px-4 py-3 font-medium">Message</th>
                    <th class="px-4 py-3 font-medium w-24">Time</th>
                    <th class="px-4 py-3 font-medium w-20">Model</th>
                    <th class="px-4 py-3 font-medium w-20 text-right">Tokens</th>
                    <th class="px-4 py-3 font-medium w-32">Tools</th>
                    <th class="px-4 py-3 font-medium w-32">LOC</th>
                </tr>
            </thead>
            <tbody>
                <template x-if="loading">
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-white/40">
                            Loading messages...
                        </td>
                    </tr>
                </template>
                <template x-if="!loading && messages.length === 0">
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-white/40">
                            No messages found
                        </td>
                    </tr>
                </template>
                <template x-for="message in messages" :key="message.index">
                    <tr class="border-b border-white/5 hover:bg-white/[0.02] cursor-pointer transition-colors"
                        :class="{'bg-white/[0.04]': selectedIndex === message.index}"
                        @click="selectMessage(message.index)">
                        <td class="px-4 py-3">
                            <span :class="typeClass(message.type)" x-text="message.type"></span>
                        </td>
                        <td class="px-4 py-3 text-white/60 truncate max-w-md" x-text="message.preview || '–'"></td>
                        <td class="px-4 py-3 text-white/40" x-text="formatTime(message.timestamp)"></td>
                        <td class="px-4 py-3 text-white/40" x-text="formatModel(message.model)"></td>
                        <td class="px-4 py-3 text-right text-white/40">
                            <template x-if="message.input_tokens || message.output_tokens">
                                <span>
                                    <span x-text="message.input_tokens || 0"></span>
                                    <span class="text-white/20">/</span>
                                    <span x-text="message.output_tokens || 0"></span>
                                </span>
                            </template>
                            <template x-if="!message.input_tokens && !message.output_tokens">
                                <span>–</span>
                            </template>
                        </td>
                        <td class="px-4 py-3 text-white/40 truncate max-w-[8rem]" x-text="message.tools.join(', ') || '–'"></td>
                        <td class="px-4 py-3">
                            <template x-if="message.is_commit">
                                <span class="inline-block px-2 py-0.5 text-xs bg-purple-500/20 text-purple-300 rounded">committed</span>
                            </template>
                            <template x-if="message.edit_loc">
                                <span class="inline-block px-2 py-0.5 text-xs bg-blue-500/20 text-blue-300 rounded" x-text="'+' + message.edit_loc.added + '/-' + message.edit_loc.removed"></span>
                            </template>
                            <template x-if="message.write_loc">
                                <span class="inline-block px-2 py-0.5 text-xs bg-green-500/20 text-green-300 rounded" x-text="'+' + message.write_loc + ' lines'"></span>
                            </template>
                            <template x-if="message.git_diff_loc">
                                <span class="inline-block px-2 py-0.5 text-xs bg-purple-500/20 text-purple-300 rounded" x-text="'+' + message.git_diff_loc.added + '/-' + message.git_diff_loc.removed"></span>
                            </template>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <!-- Side Panel -->
    <div x-show="panelOpen"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/50 z-40"
         @click="closePanel()">
    </div>

    <div x-show="panelOpen"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="translate-x-full"
         x-transition:enter-end="translate-x-0"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="translate-x-0"
         x-transition:leave-end="translate-x-full"
         class="fixed top-0 right-0 h-full w-1/2 max-w-2xl bg-[#0a0a0c] border-l border-white/10 z-50 flex flex-col"
         @click.stop>
        <div class="flex items-center justify-between px-4 py-3 border-b border-white/10">
            <h3 class="text-white/70 text-sm">
                Message <span class="text-white/40" x-text="selectedIndex"></span>
            </h3>
            <button @click="closePanel()" class="text-white/40 hover:text-white/70 text-xl">&times;</button>
        </div>
        <div class="flex-1 overflow-auto p-4">
            <template x-if="panelLoading">
                <div class="text-white/40 text-sm">Loading...</div>
            </template>
            <template x-if="!panelLoading && rawMessage">
                <pre class="text-xs text-white/70 whitespace-pre-wrap break-words" x-text="JSON.stringify(rawMessage, null, 2)"></pre>
            </template>
        </div>
    </div>
</div>
{% endblock %}
